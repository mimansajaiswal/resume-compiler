<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resume Compiler</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
  <style>
    :root {
      --oatmeal: #d5cec0;
      --earth: #b8ad9a;
      --charcoal: #2c2c2c;
      --linen: #f4f1ec;
      --linen-dark: #e8e4dc;
      --purple: #7d6b8a;
      --pink: #c4909a;
      --mono: "SF Mono", "Fira Code", "Cascadia Code", "JetBrains Mono", "Consolas", "Courier New", monospace;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--mono);
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--oatmeal);
      color: var(--charcoal);
    }

    header {
      background: var(--charcoal);
      color: var(--linen);
      padding: 0.55rem 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 10;
    }

    header h1 {
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    header .subtitle {
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      color: var(--earth);
      text-transform: uppercase;
      margin-top: 0.1rem;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .header-actions button {
      padding: 0.3rem 0.85rem;
      border: 1px solid var(--earth);
      border-radius: 0;
      font-family: var(--mono);
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      transition: all 0.15s;
    }

    #btn-download {
      background: var(--pink);
      color: var(--charcoal);
      border-color: var(--pink);
    }

    #btn-download:hover {
      background: #b37e87;
    }

    #btn-download:disabled {
      background: #666;
      color: #999;
      border-color: #666;
      cursor: not-allowed;
    }

    #btn-reset {
      background: transparent;
      color: var(--earth);
    }

    #btn-reset:hover {
      background: rgba(255, 255, 255, 0.06);
      color: var(--linen);
    }

    .main-container {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .editor-panel {
      width: 45%;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--earth);
      background: var(--linen);
    }

    .tabs {
      display: flex;
      flex-shrink: 0;
      align-items: center;
      padding: 0.5rem 0.6rem 0;
      gap: 0.35rem;
      background: var(--linen-dark);
      border-bottom: 1px solid var(--earth);
    }

    .tab {
      padding: 0.35rem 0.75rem;
      cursor: pointer;
      font-family: var(--mono);
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--earth);
      background: transparent;
      border: 1px solid transparent;
      transition: all 0.15s;
      user-select: none;
      white-space: nowrap;
      margin-bottom: -1px;
    }

    .tab:hover {
      color: var(--charcoal);
    }

    .tab.active {
      color: var(--linen);
      background: var(--charcoal);
      border-color: var(--charcoal);
    }

    .tab-actions {
      margin-left: auto;
      padding-right: 0.2rem;
      padding-bottom: 0.5rem;
      display: flex;
      gap: 0.4rem;
    }

    .tab-actions button {
      padding: 0.25rem 0.55rem;
      border: 1px solid var(--earth);
      border-radius: 0;
      background: var(--linen);
      font-family: var(--mono);
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--charcoal);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .tab-actions button:hover {
      background: var(--oatmeal);
    }

    .editor-wrapper {
      flex: 1;
      position: relative;
      min-height: 0;
      overflow: hidden;
    }

    .editor-wrapper .cm-container {
      position: absolute;
      inset: 0;
    }

    .editor-wrapper .cm-container.hidden {
      display: none;
    }

    .CodeMirror {
      height: 100% !important;
      font-family: var(--mono);
      font-size: 0.78rem;
      line-height: 1.55;
      background: var(--linen) !important;
      color: var(--charcoal) !important;
    }

    .CodeMirror-gutters {
      background: var(--linen-dark) !important;
      border-right: 1px solid var(--earth) !important;
    }

    .CodeMirror-linenumber {
      color: var(--earth) !important;
    }

    .CodeMirror-cursor {
      border-left-color: var(--purple) !important;
      border-left-width: 2px !important;
    }

    .CodeMirror-selected,
    .CodeMirror-focused .CodeMirror-selected {
      background: rgba(125, 107, 138, 0.15) !important;
    }

    .CodeMirror-activeline-background {
      background: rgba(125, 107, 138, 0.06) !important;
    }

    .cm-s-default .cm-atom {
      color: var(--purple);
    }

    .cm-s-default .cm-number {
      color: var(--pink);
    }

    .cm-s-default .cm-string {
      color: #6a7d5a;
    }

    .cm-s-default .cm-keyword {
      color: var(--purple);
    }

    .cm-s-default .cm-meta {
      color: var(--pink);
    }

    .cm-s-default .cm-comment {
      color: var(--earth);
    }

    .preview-panel {
      flex: 1;
      overflow: auto;
      background: var(--oatmeal);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem;
      gap: 1rem;
    }

    .preview-panel .page {
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--earth);
      max-width: 100%;
    }

    .preview-panel .page svg {
      display: block;
      max-width: 100%;
      height: auto;
    }

    .status-bar {
      background: var(--charcoal);
      color: var(--earth);
      padding: 0.25rem 1.2rem;
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .status-bar.error {
      color: var(--pink);
    }

    .status-bar.compiling {
      color: var(--earth);
    }

    .status-bar.ready {
      color: #8a9a7d;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(44, 44, 44, 0.94);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--linen);
      z-index: 100;
      gap: 1rem;
    }

    .loading-overlay .spinner {
      width: 32px;
      height: 32px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-top-color: var(--pink);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-overlay p {
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--earth);
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }

      .editor-panel {
        width: 100%;
        min-width: 0;
        height: 45%;
        border-right: none;
        border-bottom: 1px solid var(--earth);
      }

      .preview-panel {
        padding: 1rem;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .tab {
        padding: 0.3rem 0.6rem;
        font-size: 0.62rem;
      }
    }
  </style>
</head>

<body>

  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <p>initializing typst compiler...</p>
  </div>

  <header>
    <div>
      <h1>Resume Compiler</h1>
      <div class="subtitle">yaml + typst // pdf generator</div>
    </div>
    <div class="header-actions">
      <button id="btn-download" disabled>Download PDF</button>
      <button id="btn-reset">Reset to Defaults</button>
    </div>
  </header>

  <div class="main-container">
    <div class="editor-panel">
      <div class="tabs">
        <div class="tab active" data-tab="resume">Resume (YAML)</div>
        <div class="tab" data-tab="config">Config (YAML)</div>
        <div class="tab" data-tab="bib">Publications (BibTeX)</div>
        <div class="tab-actions">
          <button id="btn-upload" title="Upload file">Upload</button>
          <input type="file" id="file-input" accept=".yml,.yaml,.bib,.txt" style="display:none">
        </div>
      </div>
      <div class="editor-wrapper">
        <div class="cm-container" id="cm-resume"></div>
        <div class="cm-container hidden" id="cm-config"></div>
        <div class="cm-container hidden" id="cm-bib"></div>
      </div>
    </div>
    <div class="preview-panel" id="preview"></div>
  </div>

  <div class="status-bar" id="status-bar">Loading...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/yaml/yaml.min.js"></script>

  <script type="module"
    src="https://cdn.jsdelivr.net/npm/@myriaddreamin/typst.ts@0.7.0-rc2/dist/esm/contrib/all-in-one-lite.bundle.js"
    id="typst">
    </script>

  <script type="module">

    const DEFAULT_RESUME_YAML = `personal:
  name: Your Name
  email: your.email@example.com
  url: https://yourwebsite.com
  titles:
    - Your Title

work:
  - organization: Company Name
    url: https://company.com
    positions:
      - position: Your Role
        startDate: 2024-01-01
        endDate: present
        highlights:
          - "Describe your accomplishment here"

education:
  - institution: University Name
    location: City, State
    studyType: B.S.
    area: Your Major
    startDate: 2020-09-01
    endDate: 2024-05-01

skills:
  - category: Technical Skills
    skills:
      - Skill 1
      - Skill 2
      - Skill 3
`;

    const DEFAULT_CONFIG_YAML = `variant: long
fonts:
  heading_font: "New Computer Modern"
  body_font: "New Computer Modern"
  font_size: 10.5pt
  name_font_size: 1.8em
  section_font_size: 1em
  publications_font_size: 9.6pt
  awards_font_size: 10pt
layout:
  margin: 0.5in
  line_spacing: 0.82em
  list_spacing: 0.24em
  section_spacing: 0.5em
  post_section_spacing: 0.22em
  entry_spacing: 0.72em
  entry_inner_spacing: 0.26em
  work_entry_spacing: 0.56em
  work_entry_inner_spacing: 0.28em
  work_position_spacing: 0.26em
  work_bullet_spacing: 0.24em
  work_list_spacing: 0.24em
  education_entry_spacing: 0.72em
  education_entry_inner_spacing: 0.26em
  education_honors_spacing: 0.26em
  education_degree_spacing: 0.26em
  education_courses_spacing: 0.24em
  education_highlights_spacing: 0.24em
  education_list_spacing: 0.22em
  projects_entry_spacing: 0.44em
  projects_entry_inner_spacing: 0.18em
  awards_entry_spacing: 0.46em
  awards_entry_inner_spacing: 0.22em
  awards_highlights_spacing: 0.22em
  awards_list_spacing: 0.22em
  pub_spacing: 0.46em
  publications_line_spacing: 0.76em
  skill_spacing: 0.16em
  header_bottom_spacing: 0.14em
  last_updated_bottom_spacing: 0.2em
styling:
  section_smallcaps: true
  secondary_color: "#555555"
  link_color: "#0b61a4"
  section_rule_color: "#222222"
  section_rule_thickness: 0.6pt
  publications_link_style: "compact"
  contact_font_size: 0.85em
  summary_font_size: 0.92em
  last_updated_font_size: 0.72em
  last_updated_label: "Last Updated on"
visibility:
  show_location: false
  show_phone: true
  show_interests_summary: false
  show_languages: true
  show_interests: false
  show_references: false
  show_last_updated: true
section_titles:
  work: "Experience"
  education: "Education"
  publications: "Publications"
  projects: "Projects"
  awards: "Honors and Awards"
  skills: "Skills"
section_order:
  - work
  - education
  - skills
`;

const DEFAULT_BIB = `@article{example2024,
  title={Your Paper Title},
  author={Last, First and Other, Author},
  journal={Conference or Journal Name},
  year={2024},
  url={https://example.com/paper.pdf}
}
`;

    const LS_RESUME = 'resume_compiler_resume_yaml';
    const LS_CONFIG = 'resume_compiler_config_yaml';
    const LS_BIB = 'resume_compiler_publications_bib';

    const preview = document.getElementById('preview');
    const statusBar = document.getElementById('status-bar');
    const btnDownload = document.getElementById('btn-download');
    const btnReset = document.getElementById('btn-reset');
    const overlay = document.getElementById('loading-overlay');

    const cmResume = CodeMirror(document.getElementById('cm-resume'), {
      mode: 'yaml',
      lineNumbers: true,
      tabSize: 2,
      indentWithTabs: false,
      lineWrapping: true,
    });

    const cmConfig = CodeMirror(document.getElementById('cm-config'), {
      mode: 'yaml',
      lineNumbers: true,
      tabSize: 2,
      indentWithTabs: false,
      lineWrapping: true,
    });

    const cmBib = CodeMirror(document.getElementById('cm-bib'), {
      mode: null,
      lineNumbers: true,
      tabSize: 2,
      lineWrapping: true,
    });

    let activeTab = 'resume';
    const editors = { resume: cmResume, config: cmConfig, bib: cmBib };
    const containers = {
      resume: document.getElementById('cm-resume'),
      config: document.getElementById('cm-config'),
      bib: document.getElementById('cm-bib'),
    };

    let templateContent = '';
    let compileTimeout = null;
    let ready = false;

    function setStatus(text, level) {
      statusBar.textContent = text;
      statusBar.className = 'status-bar' + (level ? ' ' + level : '');
    }

    const tabs = document.querySelectorAll('.tab[data-tab]');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        activeTab = tab.dataset.tab;
        Object.entries(containers).forEach(([key, el]) => {
          el.classList.toggle('hidden', key !== activeTab);
        });
        editors[activeTab].refresh();
      });
    });

    const btnUpload = document.getElementById('btn-upload');
    const fileInput = document.getElementById('file-input');
    btnUpload.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        editors[activeTab].setValue(ev.target.result);
        scheduleCompile();
      };
      reader.readAsText(file);
      fileInput.value = '';
    });

    function scheduleCompile() {
      if (compileTimeout) clearTimeout(compileTimeout);
      compileTimeout = setTimeout(compile, 600);
    }

    cmResume.on('change', scheduleCompile);
    cmConfig.on('change', scheduleCompile);
    cmBib.on('change', scheduleCompile);

    function getMainContent() {
      const bibContent = cmBib.getValue().trim();
      if (bibContent) {
        return `#import "/template.typ": build_resume\n#let resume_data = yaml("/resume.yml")\n#build_resume(resume_data, (:), config_file: "/config.yml", bib_file: "/publications.bib")`;
      }
      return `#import "/template.typ": build_resume\n#let resume_data = yaml("/resume.yml")\n#build_resume(resume_data, (:), config_file: "/config.yml")`;
    }

    function formatLastUpdatedDate(dateObj = new Date()) {
      return dateObj.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
      });
    }

    function injectLastUpdated(configText) {
      const stamp = formatLastUpdatedDate();
      const line = `last_updated: "${stamp}"`;
      const hasLine = /^\s*last_updated\s*:/m.test(configText);
      if (hasLine) {
        return configText.replace(/^\s*last_updated\s*:.+$/m, line);
      }
      return `${line}\n${configText}`;
    }

    async function compile() {
      if (!ready) return;

      setStatus('Compiling...', 'compiling');

      try {
        await $typst.addSource('/template.typ', templateContent);
        await $typst.addSource('/resume.yml', cmResume.getValue());
        const runtimeConfig = injectLastUpdated(cmConfig.getValue());
        await $typst.addSource('/config.yml', runtimeConfig);

        const bibContent = cmBib.getValue().trim();
        if (bibContent) {
          await $typst.addSource('/publications.bib', bibContent);
        }

        const mainContent = getMainContent();
        const result = await $typst.svg({ mainContent });

        preview.innerHTML = '';

        if (typeof result === 'string') {
          const page = document.createElement('div');
          page.className = 'page';
          page.innerHTML = result;
          preview.appendChild(page);
        } else if (Array.isArray(result)) {
          result.forEach(pageSvg => {
            const page = document.createElement('div');
            page.className = 'page';
            page.innerHTML = pageSvg;
            preview.appendChild(page);
          });
        }

        localStorage.setItem(LS_RESUME, cmResume.getValue());
        localStorage.setItem(LS_CONFIG, cmConfig.getValue());
        localStorage.setItem(LS_BIB, cmBib.getValue());

        setStatus('Ready', 'ready');
      } catch (err) {
        setStatus('Error: ' + err.message, 'error');
      }
    }

    btnDownload.addEventListener('click', async () => {
      if (!ready) return;
      btnDownload.disabled = true;
      setStatus('Generating PDF...', 'compiling');

      try {
        await $typst.addSource('/template.typ', templateContent);
        await $typst.addSource('/resume.yml', cmResume.getValue());
        const runtimeConfig = injectLastUpdated(cmConfig.getValue());
        await $typst.addSource('/config.yml', runtimeConfig);

        const bibContent = cmBib.getValue().trim();
        if (bibContent) {
          await $typst.addSource('/publications.bib', bibContent);
        }

        const mainContent = getMainContent();
        const pdfData = await $typst.pdf({ mainContent });
        const blob = new Blob([pdfData], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'resume.pdf';
        a.click();
        URL.revokeObjectURL(url);
        setStatus('Ready', 'ready');
      } catch (err) {
        setStatus('PDF error: ' + err.message, 'error');
      } finally {
        btnDownload.disabled = false;
      }
    });

    btnReset.addEventListener('click', () => {
      if (!confirm('Reset all editors to defaults? Your changes will be lost.')) return;
      localStorage.removeItem(LS_RESUME);
      localStorage.removeItem(LS_CONFIG);
      localStorage.removeItem(LS_BIB);
      location.reload();
    });

    async function fetchText(url) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Failed to fetch ${url}: ${resp.status}`);
      return resp.text();
    }

    async function loadDefaults() {
      let resumeYaml = DEFAULT_RESUME_YAML;
      let configYaml = DEFAULT_CONFIG_YAML;
      let bibContent = DEFAULT_BIB;
      templateContent = await fetchText('./template.typ');

      try { resumeYaml = await fetchText('./default-resume.yml'); } catch (e) { }
      try { configYaml = await fetchText('./default-config.yml'); } catch (e) { }
      try { bibContent = await fetchText('./default-publications.bib'); } catch (e) { }

      return { resumeYaml, configYaml, bibContent };
    }

    async function init() {
      setStatus('Loading defaults...', '');
      let defaults = null;
      try {
        defaults = await loadDefaults();
      } catch (err) {
        overlay.querySelector('p').textContent = 'Failed: ' + err.message;
        setStatus('Init failed: ' + err.message, 'error');
        return;
      }

      cmResume.setValue(localStorage.getItem(LS_RESUME) || defaults.resumeYaml);
      cmConfig.setValue(localStorage.getItem(LS_CONFIG) || defaults.configYaml);
      cmBib.setValue(localStorage.getItem(LS_BIB) || defaults.bibContent);

      const typstScript = document.getElementById('typst');

      function tryInit() {
        if (typeof globalThis.$typst !== 'undefined') {
          initTypst();
        } else {
          setTimeout(tryInit, 200);
        }
      }

      if (typstScript.complete || typeof globalThis.$typst !== 'undefined') {
        setTimeout(tryInit, 100);
      } else {
        typstScript.addEventListener('load', () => setTimeout(tryInit, 100));
      }
    }

    async function initTypst() {
      try {
        $typst.setCompilerInitOptions({
          getModule: () =>
            'https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-web-compiler/pkg/typst_ts_web_compiler_bg.wasm',
        });
        $typst.setRendererInitOptions({
          getModule: () =>
            'https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-renderer/pkg/typst_ts_renderer_bg.wasm',
        });
        ready = true;
        overlay.style.display = 'none';
        btnDownload.disabled = false;
        setStatus('Ready', 'ready');
        compile();
      } catch (err) {
        overlay.querySelector('p').textContent = 'Failed: ' + err.message;
        setStatus('Init failed: ' + err.message, 'error');
      }
    }

    init();

  </script>
</body>

</html>
