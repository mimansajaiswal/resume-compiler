<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resume Compiler</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.css">
  <style>
    :root {
      --oatmeal: #d5cec0;
      --earth: #b8ad9a;
      --charcoal: #2c2c2c;
      --linen: #f4f1ec;
      --linen-dark: #e8e4dc;
      --purple: #7d6b8a;
      --pink: #c4909a;
      --mono: "SF Mono", "Fira Code", "Cascadia Code", "JetBrains Mono", "Consolas", "Courier New", monospace;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--mono);
      height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--oatmeal);
      color: var(--charcoal);
    }

    header {
      background: var(--charcoal);
      color: var(--linen);
      padding: 0.55rem 1.2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      z-index: 10;
    }

    header h1 {
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    header .subtitle {
      font-size: 0.65rem;
      letter-spacing: 0.08em;
      color: var(--earth);
      text-transform: uppercase;
      margin-top: 0.1rem;
    }

    .header-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .paper-size-wrap {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      color: var(--earth);
      font-size: 0.62rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-weight: 700;
    }

    .paper-size-wrap select {
      background: transparent;
      color: var(--linen);
      border: 1px solid var(--earth);
      border-radius: 0;
      font-family: var(--mono);
      font-size: 0.65rem;
      padding: 0.2rem 0.35rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      cursor: pointer;
    }

    .header-actions button {
      padding: 0.3rem 0.85rem;
      border: 1px solid var(--earth);
      border-radius: 0;
      font-family: var(--mono);
      font-size: 0.7rem;
      font-weight: 600;
      cursor: pointer;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      transition: all 0.15s;
    }

    #btn-download {
      background: var(--pink);
      color: var(--charcoal);
      border-color: var(--pink);
    }

    #btn-download:hover {
      background: #b37e87;
    }

    #btn-download:disabled {
      background: #666;
      color: #999;
      border-color: #666;
      cursor: not-allowed;
    }

    #btn-download-typ {
      background: transparent;
      color: var(--earth);
    }

    #btn-download-typ:hover {
      background: rgba(255, 255, 255, 0.06);
      color: var(--linen);
    }

    #btn-reset {
      background: transparent;
      color: var(--earth);
    }

    #btn-reset:hover {
      background: rgba(255, 255, 255, 0.06);
      color: var(--linen);
    }

    .main-container {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .editor-panel {
      width: 45%;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--earth);
      background: var(--linen);
    }

    .tabs {
      display: flex;
      flex-shrink: 0;
      align-items: center;
      padding: 0.5rem 0.6rem 0;
      gap: 0.35rem;
      background: var(--linen-dark);
      border-bottom: 1px solid var(--earth);
    }

    .tab {
      padding: 0.35rem 0.75rem;
      cursor: pointer;
      font-family: var(--mono);
      font-size: 0.68rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--earth);
      background: transparent;
      border: 1px solid transparent;
      transition: all 0.15s;
      user-select: none;
      white-space: nowrap;
      margin-bottom: -1px;
    }

    .tab:hover {
      color: var(--charcoal);
    }

    .tab.active {
      color: var(--linen);
      background: var(--charcoal);
      border-color: var(--charcoal);
    }

    .tab-actions {
      margin-left: auto;
      padding-right: 0.2rem;
      padding-bottom: 0.5rem;
      display: flex;
      gap: 0.4rem;
    }

    .tab-actions button {
      padding: 0.25rem 0.55rem;
      border: 1px solid var(--earth);
      border-radius: 0;
      background: var(--linen);
      font-family: var(--mono);
      font-size: 0.65rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--charcoal);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .tab-actions button:hover {
      background: var(--oatmeal);
    }

    .schema-help {
      border-bottom: 1px solid var(--earth);
      background: var(--linen-dark);
      padding: 0.35rem 0.7rem;
      font-size: 0.66rem;
      line-height: 1.45;
      color: var(--charcoal);
    }

    .schema-help summary {
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--charcoal);
    }

    .schema-help code {
      font-family: var(--mono);
      font-size: 0.64rem;
      background: #ece7dd;
      padding: 0.02rem 0.2rem;
    }

    .schema-help iconify-icon {
      font-size: 0.78rem;
      vertical-align: -0.12em;
      margin-right: 0.14rem;
    }

    .override-panel {
      border-bottom: 1px solid var(--earth);
      background: #efebe3;
      padding: 0.45rem 0.7rem 0.55rem;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.45rem 0.55rem;
    }

    .override-item {
      display: flex;
      flex-direction: column;
      gap: 0.16rem;
    }

    .override-item label {
      font-size: 0.62rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #5a5449;
    }

    .override-item select {
      font-family: var(--mono);
      font-size: 0.68rem;
      padding: 0.2rem 0.28rem;
      border: 1px solid var(--earth);
      background: var(--linen);
      color: var(--charcoal);
    }

    .editor-wrapper {
      flex: 1;
      position: relative;
      min-height: 0;
      overflow: hidden;
    }

    .editor-wrapper .cm-container {
      position: absolute;
      inset: 0;
    }

    .editor-wrapper .cm-container.hidden {
      display: none;
    }

    .CodeMirror {
      height: 100% !important;
      font-family: var(--mono);
      font-size: 0.78rem;
      line-height: 1.55;
      background: var(--linen) !important;
      color: var(--charcoal) !important;
    }

    .CodeMirror-gutters {
      background: var(--linen-dark) !important;
      border-right: 1px solid var(--earth) !important;
    }

    .CodeMirror-linenumber {
      color: var(--earth) !important;
    }

    .CodeMirror-cursor {
      border-left-color: var(--purple) !important;
      border-left-width: 2px !important;
    }

    .CodeMirror-selected,
    .CodeMirror-focused .CodeMirror-selected {
      background: rgba(125, 107, 138, 0.15) !important;
    }

    .CodeMirror-activeline-background {
      background: rgba(125, 107, 138, 0.06) !important;
    }

    .cm-s-default .cm-atom {
      color: var(--purple);
    }

    .cm-s-default .cm-number {
      color: var(--pink);
    }

    .cm-s-default .cm-string {
      color: #6a7d5a;
    }

    .cm-s-default .cm-keyword {
      color: var(--purple);
    }

    .cm-s-default .cm-meta {
      color: var(--pink);
    }

    .cm-s-default .cm-comment {
      color: var(--earth);
    }

    .preview-panel {
      flex: 1;
      overflow: auto;
      background: var(--oatmeal);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem;
      gap: 1rem;
    }

    .preview-panel .page {
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      border: 1px solid var(--earth);
      max-width: 100%;
    }

    .preview-panel .page svg {
      display: block;
      max-width: 100%;
      height: auto;
    }

    .status-bar {
      background: var(--charcoal);
      color: var(--earth);
      padding: 0.25rem 1.2rem;
      font-family: var(--mono);
      font-size: 0.65rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .status-bar.error {
      color: var(--pink);
    }

    .status-bar.compiling {
      color: var(--earth);
    }

    .status-bar.ready {
      color: #8a9a7d;
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(44, 44, 44, 0.94);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--linen);
      z-index: 100;
      gap: 1rem;
    }

    .loading-overlay .spinner {
      width: 32px;
      height: 32px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-top-color: var(--pink);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-overlay p {
      font-family: var(--mono);
      font-size: 0.75rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--earth);
    }

    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }

      .editor-panel {
        width: 100%;
        min-width: 0;
        height: 45%;
        border-right: none;
        border-bottom: 1px solid var(--earth);
      }

      .preview-panel {
        padding: 1rem;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .tab {
        padding: 0.3rem 0.6rem;
        font-size: 0.62rem;
      }

      .paper-size-wrap span {
        display: none;
      }
    }
  </style>
</head>

<body>

  <div class="loading-overlay" id="loading-overlay">
    <div class="spinner"></div>
    <p>initializing typst compiler...</p>
  </div>

  <header>
    <div>
      <h1>Resume Compiler</h1>
      <div class="subtitle">yaml + typst // pdf generator</div>
    </div>
    <div class="header-actions">
      <label class="paper-size-wrap">
        <span>Paper</span>
        <select id="paper-size">
          <option value="letter">Letter</option>
          <option value="a4">A4</option>
        </select>
      </label>
      <button id="btn-download" disabled>Download PDF</button>
      <button id="btn-download-typ">Download resume.typ</button>
      <button id="btn-reset">Reset to Defaults</button>
    </div>
  </header>

  <div class="main-container">
    <div class="editor-panel">
      <div class="tabs">
        <div class="tab active" data-tab="resume">Resume (YAML)</div>
        <div class="tab" data-tab="config">Config (YAML)</div>
        <div class="tab" data-tab="bib">Publications (BibTeX)</div>
        <div class="tab-actions">
          <button id="btn-upload" title="Upload file">Upload</button>
          <input type="file" id="file-input" accept=".yml,.yaml,.bib,.txt" style="display:none">
        </div>
      </div>
      <details class="schema-help">
        <summary>Supported Keys</summary>
        <div>
          <div>Schema style is standardized (no legacy aliases): use the keys shown below directly.</div>
          <div>Work: <code>work[].name</code>, <code>work[].positions[].name</code>, <code>work[].positions[].content[]</code></div>
          <div>Education: <code>education[].name</code>, optional <code>content[]</code>, <code>honors[]</code>, <code>courses[]</code>, <code>thesis</code></div>
          <div>Publications: <code>bib_key</code> or markdown-first entries with <code>name</code> (title), <code>content</code> (details), <code>authors</code>, <code>links[]</code></div>
          <div>BibTeX links: set <code>publications[].url</code> to override, or omit it to use the BibTeX <code>url</code> field.</div>
          <div>No-link behavior: <code>visibility.links_disabled_behavior</code> = <code>label</code> or <code>label_with_url</code>.</div>
          <div>Generic sections: any extra top-level array (example: <code>community_service</code>) auto-renders even if not in <code>section_order</code>.</div>
          <div>Fonts: configure <code>fonts.font</code> (general) and <code>fonts.mono_font</code> (inline code/monospace).</div>
          <div>Contact icons: <iconify-icon icon="mdi:phone-outline"></iconify-icon><iconify-icon icon="mdi:email-outline"></iconify-icon><iconify-icon icon="mdi:web"></iconify-icon><iconify-icon icon="mdi:github"></iconify-icon><iconify-icon icon="mdi:linkedin"></iconify-icon> set <code>styling.contact_display_mode</code> to <code>label</code>, <code>icon_label</code>, or <code>icon</code>.</div>
        </div>
      </details>
      <div class="override-panel">
        <div class="override-item">
          <label for="override-variant">Variant Override</label>
          <select id="override-variant">
            <option value="config">Use config.yml</option>
            <option value="long">Long</option>
            <option value="short">Short</option>
          </select>
        </div>
        <div class="override-item">
          <label for="override-links">Links Override</label>
          <select id="override-links">
            <option value="config">Use config.yml</option>
            <option value="on">Enabled</option>
            <option value="off">Disabled</option>
          </select>
        </div>
        <div class="override-item">
          <label for="override-links-disabled-behavior">Link-Off Rendering</label>
          <select id="override-links-disabled-behavior">
            <option value="config">Use config.yml</option>
            <option value="label">Keep Label Only</option>
            <option value="label_with_url">Label + [url]</option>
          </select>
        </div>
        <div class="override-item">
          <label for="override-pubnums">Pub Numbers Override</label>
          <select id="override-pubnums">
            <option value="config">Use config.yml</option>
            <option value="on">Show [n]</option>
            <option value="off">Hide [n]</option>
          </select>
        </div>
        <div class="override-item">
          <label for="override-contact">Contact Style Override</label>
          <select id="override-contact">
            <option value="config">Use config.yml</option>
            <option value="label">Label</option>
            <option value="icon_label">Icon + Label</option>
            <option value="icon">Icon Only</option>
          </select>
        </div>
        <div class="override-item">
          <label for="override-font">General Font Override</label>
          <select id="override-font">
            <option value="config">Use config.yml</option>
            <option value="New Computer Modern">New Computer Modern</option>
            <option value="Libertinus Serif">Libertinus Serif</option>
            <option value="TeX Gyre Termes">TeX Gyre Termes</option>
            <option value="TeX Gyre Pagella">TeX Gyre Pagella</option>
            <option value="DejaVu Serif">DejaVu Serif</option>
          </select>
        </div>
        <div class="override-item">
          <label for="override-mono-font">Monospace Font Override</label>
          <select id="override-mono-font">
            <option value="config">Use config.yml</option>
            <option value="DejaVu Sans Mono">DejaVu Sans Mono</option>
            <option value="Libertinus Mono">Libertinus Mono</option>
            <option value="New Computer Modern Mono">New Computer Modern Mono</option>
            <option value="Fira Code">Fira Code</option>
            <option value="JetBrains Mono">JetBrains Mono</option>
            <option value="Cascadia Mono">Cascadia Mono</option>
          </select>
        </div>
      </div>
      <div class="editor-wrapper">
        <div class="cm-container" id="cm-resume"></div>
        <div class="cm-container hidden" id="cm-config"></div>
        <div class="cm-container hidden" id="cm-bib"></div>
      </div>
    </div>
    <div class="preview-panel" id="preview"></div>
  </div>

  <div class="status-bar" id="status-bar">Loading...</div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.18/mode/yaml/yaml.min.js"></script>
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>

  <script type="module"
    src="https://cdn.jsdelivr.net/npm/@myriaddreamin/typst.ts@0.7.0-rc2/dist/esm/contrib/all-in-one-lite.bundle.js"
    id="typst">
    </script>

  <script type="module">

    const DEFAULT_RESUME_YAML = `personal:
  name: Your Name
  email: your.email@example.com
  url: https://yourwebsite.com
  titles:
    - Your Title

work:
  - name: Company Name
    url: https://company.com
    positions:
      - name: Senior Research Engineer
        startDate: 2024-01-01
        endDate: present
        content:
          - "Describe your current-role accomplishments here"
      - name: Research Engineer
        startDate: 2022-01-01
        endDate: 2023-12-01
        content:
          - "Describe your previous role at the same company here"

education:
  - name: University Name
    location: City, State
    studyType: B.S.
    area: Your Major
    startDate: 2020-09-01
    endDate: 2024-05-01
    content:
      - "*Advisor*: Prof. Example Person"

# Generic section example (auto-rendered even if omitted from section_order):
community_service:
  - name: Theorem Proving Reading Group
    startDate: 2023-01-01
    endDate: present
    content:
      - "Organize monthly paper discussions and proof clinics."

skills:
  - category: Technical Skills
    skills:
      - Skill 1
      - Skill 2
      - Skill 3
`;

const DEFAULT_CONFIG_YAML = `variant: long
paper_size: "letter"
fonts:
  font: "New Computer Modern"
  mono_font: "DejaVu Sans Mono"
  font_size: 10pt
  name_font_size: 1.4em
  section_font_size: 1em
  publications_font_size: 9.6pt
  awards_font_size: 10pt
layout:
  margin: 0.5in
  line_spacing: 0.33em
  list_spacing: 0.61em
  section_spacing: 1.2em
  post_section_spacing: 0.78em
  entry_spacing: 0.62em
  entry_inner_spacing: 0.48em
  pub_spacing: 0.61em
  publications_line_spacing: 0.33em
  publications_heading_tighten: 0pt
  skill_spacing: 0.61em
  header_rule_top_spacing: 0.52em
  header_bottom_spacing: 0.3em
  last_updated_bottom_spacing: 0.2em
styling:
  section_smallcaps: false
  secondary_color: "#111111"
  link_color: "#1C398D"
  section_rule_color: "#9F9FA8"
  section_rule_thickness: 0.6pt
  header_rule_color: "#9F9FA8"
  publications_link_style: "compact"
  contact_font_size: 0.85em
  summary_font_size: 1em
  last_updated_font_size: 0.8em
  last_updated_label: "Last Updated on"
  contact_display_mode: "label"
  contact_icon_family: "lucide"
  contact_icon_spacing: 0.18em
visibility:
  show_location: false
  show_phone: true
  show_interests_summary: false
  show_languages: true
  show_interests: false
  show_references: false
  show_last_updated: true
  enable_links: true
  links_disabled_behavior: "label"
  show_publication_numbers: false
section_titles:
  work: "Experience"
  education: "Education"
  publications: "Publications"
  projects: "Projects"
  awards: "Honors and Awards"
  skills: "Skills"
section_order:
  - work
  - education
  - skills
`;

const DEFAULT_BIB = `@article{example2024,
  title={Your Paper Title},
  author={Last, First and Other, Author},
  journal={Conference or Journal Name},
  year={2024},
  url={https://example.com/paper.pdf}
}
`;

    const LS_RESUME = 'resume_compiler_resume_yaml';
    const LS_CONFIG = 'resume_compiler_config_yaml';
    const LS_BIB = 'resume_compiler_publications_bib';
    const LS_PAPER = 'resume_compiler_paper_size';
    const LS_OVERRIDE_VARIANT = 'resume_compiler_override_variant';
    const LS_OVERRIDE_LINKS = 'resume_compiler_override_links';
    const LS_OVERRIDE_LINKS_DISABLED_BEHAVIOR = 'resume_compiler_override_links_disabled_behavior';
    const LS_OVERRIDE_PUBNUMS = 'resume_compiler_override_pubnums';
    const LS_OVERRIDE_CONTACT = 'resume_compiler_override_contact';
    const LS_OVERRIDE_FONT = 'resume_compiler_override_font';
    const LS_OVERRIDE_MONO_FONT = 'resume_compiler_override_mono_font';

    const preview = document.getElementById('preview');
    const statusBar = document.getElementById('status-bar');
    const btnDownload = document.getElementById('btn-download');
    const btnDownloadTyp = document.getElementById('btn-download-typ');
    const btnReset = document.getElementById('btn-reset');
    const paperSize = document.getElementById('paper-size');
    const overrideVariant = document.getElementById('override-variant');
    const overrideLinks = document.getElementById('override-links');
    const overrideLinksDisabledBehavior = document.getElementById('override-links-disabled-behavior');
    const overridePubnums = document.getElementById('override-pubnums');
    const overrideContact = document.getElementById('override-contact');
    const overrideFont = document.getElementById('override-font');
    const overrideMonoFont = document.getElementById('override-mono-font');
    const overlay = document.getElementById('loading-overlay');

    const cmResume = CodeMirror(document.getElementById('cm-resume'), {
      mode: 'yaml',
      lineNumbers: true,
      tabSize: 2,
      indentWithTabs: false,
      lineWrapping: true,
    });

    const cmConfig = CodeMirror(document.getElementById('cm-config'), {
      mode: 'yaml',
      lineNumbers: true,
      tabSize: 2,
      indentWithTabs: false,
      lineWrapping: true,
    });

    const cmBib = CodeMirror(document.getElementById('cm-bib'), {
      mode: null,
      lineNumbers: true,
      tabSize: 2,
      lineWrapping: true,
    });

    let activeTab = 'resume';
    const editors = { resume: cmResume, config: cmConfig, bib: cmBib };
    const containers = {
      resume: document.getElementById('cm-resume'),
      config: document.getElementById('cm-config'),
      bib: document.getElementById('cm-bib'),
    };

    let templateContent = '';
    let compileTimeout = null;
    let ready = false;

    function setStatus(text, level) {
      statusBar.textContent = text;
      statusBar.className = 'status-bar' + (level ? ' ' + level : '');
    }

    const tabs = document.querySelectorAll('.tab[data-tab]');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        activeTab = tab.dataset.tab;
        Object.entries(containers).forEach(([key, el]) => {
          el.classList.toggle('hidden', key !== activeTab);
        });
        editors[activeTab].refresh();
      });
    });

    const btnUpload = document.getElementById('btn-upload');
    const fileInput = document.getElementById('file-input');
    btnUpload.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        editors[activeTab].setValue(ev.target.result);
        scheduleCompile();
      };
      reader.readAsText(file);
      fileInput.value = '';
    });

    function scheduleCompile() {
      if (compileTimeout) clearTimeout(compileTimeout);
      compileTimeout = setTimeout(compile, 600);
    }

    cmResume.on('change', scheduleCompile);
    cmConfig.on('change', scheduleCompile);
    cmBib.on('change', scheduleCompile);

    function formatLastUpdatedDate(dateObj = new Date()) {
      return dateObj.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric',
      });
    }

    function detectPaperSize(configText) {
      const m = configText.match(/^\s*paper_size\s*:\s*["']?([A-Za-z-]+)["']?\s*$/m);
      if (!m) return 'letter';
      return m[1].toLowerCase() === 'a4' ? 'a4' : 'letter';
    }

    function parseConfigBoolean(configText, key, fallback) {
      const top = configText.match(new RegExp(`^\\s*${key}\\s*:\\s*(true|false)\\s*$`, 'mi'));
      const nested = configText.match(new RegExp(`^\\s{2}${key}\\s*:\\s*(true|false)\\s*$`, 'mi'));
      if (top) return top[1].toLowerCase() === 'true';
      if (nested) return nested[1].toLowerCase() === 'true';
      return fallback;
    }

    function parseConfigVariant(configText) {
      const m = configText.match(/^\s*variant\s*:\s*["']?([A-Za-z-]+)["']?\s*$/m);
      return m ? m[1].toLowerCase() : 'long';
    }

    function escapeTypstString(value) {
      return String(value).replace(/\\/g, '\\\\').replace(/"/g, '\\"');
    }

    function getRuntimeOverridesObject() {
      const overrides = {
        last_updated: formatLastUpdatedDate(),
        paper_size: paperSize.value,
      };

      if (overrideVariant.value !== 'config') {
        overrides.variant = overrideVariant.value;
      }
      if (overrideLinks.value === 'on') {
        overrides.enable_links = true;
      } else if (overrideLinks.value === 'off') {
        overrides.enable_links = false;
      }
      if (overrideLinksDisabledBehavior.value !== 'config') {
        overrides.links_disabled_behavior = overrideLinksDisabledBehavior.value;
      }
      if (overridePubnums.value === 'on') {
        overrides.show_publication_numbers = true;
      } else if (overridePubnums.value === 'off') {
        overrides.show_publication_numbers = false;
      }
      if (overrideContact.value !== 'config') {
        overrides.contact_display_mode = overrideContact.value;
      }
      if (overrideFont.value !== 'config') {
        overrides.font = overrideFont.value;
      }
      if (overrideMonoFont.value !== 'config') {
        overrides.mono_font = overrideMonoFont.value;
      }

      return overrides;
    }

    function overridesToTypstDict(overrides) {
      const parts = [];
      Object.entries(overrides).forEach(([key, value]) => {
        if (typeof value === 'boolean') {
          parts.push(`${key}: ${value ? 'true' : 'false'}`);
        } else {
          parts.push(`${key}: "${escapeTypstString(value)}"`);
        }
      });
      return `(${parts.join(', ')})`;
    }

    function getResumeTypSource() {
      const bibContent = cmBib.getValue().trim();
      const runtimeOverrides = overridesToTypstDict(getRuntimeOverridesObject());
      if (bibContent) {
        return `#import "/template.typ": build_resume\n#let resume_data = yaml("/resume.yml")\n#let runtime_overrides = ${runtimeOverrides}\n#build_resume(resume_data, runtime_overrides, config_file: "/config.yml", bib_file: "/publications.bib")`;
      }
      return `#import "/template.typ": build_resume\n#let resume_data = yaml("/resume.yml")\n#let runtime_overrides = ${runtimeOverrides}\n#build_resume(resume_data, runtime_overrides, config_file: "/config.yml")`;
    }

    function getMainContent() {
      return `#include "/resume.typ"`;
    }

    function detectVariantSuffix(configText, bibText = '') {
      const hasBib = Boolean((bibText || '').trim());
      let enableLinks = parseConfigBoolean(configText, 'enable_links', true);
      let variant = parseConfigVariant(configText);
      if (overrideLinks.value === 'on') enableLinks = true;
      if (overrideLinks.value === 'off') enableLinks = false;
      if (overrideVariant.value !== 'config') variant = overrideVariant.value;

      if (!enableLinks) return '_N';
      if (hasBib) return '_B';
      if (variant === 'short') return '_S';
      if (variant === 'long') return '';
      return '_C';
    }

    function deriveResumeFilename(resumeYamlText, configText, bibText) {
      const lines = resumeYamlText.split(/\r?\n/);
      let inPersonal = false;
      let fullName = '';
      for (const line of lines) {
        if (!inPersonal && /^\s*personal:\s*$/.test(line)) {
          inPersonal = true;
          continue;
        }
        if (inPersonal && /^[^\s#]/.test(line)) break;
        if (inPersonal) {
          const m = line.match(/^\s{2}name:\s*["']?([^"'\n]+)["']?\s*$/);
          if (m) {
            fullName = m[1].trim();
            break;
          }
        }
      }

      const variantSuffix = detectVariantSuffix(configText, bibText);
      if (!fullName) return `Resume${variantSuffix}.pdf`;
      const tokens = fullName.split(/\s+/).filter(Boolean);
      if (tokens.length === 0) return `Resume${variantSuffix}.pdf`;
      const first = tokens[0];
      const last = tokens.length > 1 ? tokens[tokens.length - 1] : '';
      const compact = `${first}${last}`.replace(/[^A-Za-z0-9]/g, '');
      if (!compact) return `Resume${variantSuffix}.pdf`;
      return `${compact}_Resume${variantSuffix}.pdf`;
    }

    async function compile() {
      if (!ready) return;

      setStatus('Compiling...', 'compiling');

      try {
        await $typst.addSource('/template.typ', templateContent);
        await $typst.addSource('/resume.yml', cmResume.getValue());
        await $typst.addSource('/resume.typ', getResumeTypSource());
        await $typst.addSource('/config.yml', cmConfig.getValue());

        const bibContent = cmBib.getValue().trim();
        if (bibContent) {
          await $typst.addSource('/publications.bib', bibContent);
        }

        const mainContent = getMainContent();
        const result = await $typst.svg({ mainContent });

        preview.innerHTML = '';

        if (typeof result === 'string') {
          const page = document.createElement('div');
          page.className = 'page';
          page.innerHTML = result;
          preview.appendChild(page);
        } else if (Array.isArray(result)) {
          result.forEach(pageSvg => {
            const page = document.createElement('div');
            page.className = 'page';
            page.innerHTML = pageSvg;
            preview.appendChild(page);
          });
        }

        localStorage.setItem(LS_RESUME, cmResume.getValue());
        localStorage.setItem(LS_CONFIG, cmConfig.getValue());
        localStorage.setItem(LS_BIB, cmBib.getValue());
        localStorage.setItem(LS_PAPER, paperSize.value);
        localStorage.setItem(LS_OVERRIDE_VARIANT, overrideVariant.value);
        localStorage.setItem(LS_OVERRIDE_LINKS, overrideLinks.value);
        localStorage.setItem(LS_OVERRIDE_LINKS_DISABLED_BEHAVIOR, overrideLinksDisabledBehavior.value);
        localStorage.setItem(LS_OVERRIDE_PUBNUMS, overridePubnums.value);
        localStorage.setItem(LS_OVERRIDE_CONTACT, overrideContact.value);
        localStorage.setItem(LS_OVERRIDE_FONT, overrideFont.value);
        localStorage.setItem(LS_OVERRIDE_MONO_FONT, overrideMonoFont.value);

        setStatus('Ready', 'ready');
      } catch (err) {
        setStatus('Error: ' + err.message, 'error');
      }
    }

    btnDownload.addEventListener('click', async () => {
      if (!ready) return;
      btnDownload.disabled = true;
      setStatus('Generating PDF...', 'compiling');

      try {
        await $typst.addSource('/template.typ', templateContent);
        await $typst.addSource('/resume.yml', cmResume.getValue());
        await $typst.addSource('/resume.typ', getResumeTypSource());
        await $typst.addSource('/config.yml', cmConfig.getValue());

        const bibContent = cmBib.getValue().trim();
        if (bibContent) {
          await $typst.addSource('/publications.bib', bibContent);
        }

        const mainContent = getMainContent();
        const pdfData = await $typst.pdf({ mainContent });
        const blob = new Blob([pdfData], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = deriveResumeFilename(cmResume.getValue(), cmConfig.getValue(), cmBib.getValue());
        a.click();
        URL.revokeObjectURL(url);
        setStatus('Ready', 'ready');
      } catch (err) {
        setStatus('PDF error: ' + err.message, 'error');
      } finally {
        btnDownload.disabled = false;
      }
    });

    btnDownloadTyp.addEventListener('click', () => {
      const typSource = getResumeTypSource();
      const blob = new Blob([typSource], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'resume.typ';
      a.click();
      URL.revokeObjectURL(url);
    });

    btnReset.addEventListener('click', () => {
      if (!confirm('Reset all editors to defaults? Your changes will be lost.')) return;
      localStorage.removeItem(LS_RESUME);
      localStorage.removeItem(LS_CONFIG);
      localStorage.removeItem(LS_BIB);
      localStorage.removeItem(LS_PAPER);
      localStorage.removeItem(LS_OVERRIDE_VARIANT);
      localStorage.removeItem(LS_OVERRIDE_LINKS);
      localStorage.removeItem(LS_OVERRIDE_LINKS_DISABLED_BEHAVIOR);
      localStorage.removeItem(LS_OVERRIDE_PUBNUMS);
      localStorage.removeItem(LS_OVERRIDE_CONTACT);
      localStorage.removeItem(LS_OVERRIDE_FONT);
      localStorage.removeItem(LS_OVERRIDE_MONO_FONT);
      location.reload();
    });

    paperSize.addEventListener('change', () => {
      localStorage.setItem(LS_PAPER, paperSize.value);
      scheduleCompile();
    });
    overrideVariant.addEventListener('change', scheduleCompile);
    overrideLinks.addEventListener('change', scheduleCompile);
    overrideLinksDisabledBehavior.addEventListener('change', scheduleCompile);
    overridePubnums.addEventListener('change', scheduleCompile);
    overrideContact.addEventListener('change', scheduleCompile);
    overrideFont.addEventListener('change', scheduleCompile);
    overrideMonoFont.addEventListener('change', scheduleCompile);

    async function fetchText(url) {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Failed to fetch ${url}: ${resp.status}`);
      return resp.text();
    }

    async function fetchTextAny(paths) {
      let lastError = null;
      for (const p of paths) {
        try {
          return await fetchText(p);
        } catch (err) {
          lastError = err;
        }
      }
      throw lastError || new Error(`Failed to fetch any candidate path: ${paths.join(', ')}`);
    }

    function computeRepoBasePrefix() {
      const path = window.location.pathname || '';
      const webWithSlashIdx = path.indexOf('/web/');
      if (webWithSlashIdx >= 0) return path.slice(0, webWithSlashIdx);
      if (path.endsWith('/web')) return path.slice(0, -4);
      return '';
    }

    async function loadDefaults() {
      let resumeYaml = DEFAULT_RESUME_YAML;
      let configYaml = DEFAULT_CONFIG_YAML;
      let bibContent = DEFAULT_BIB;
      const basePrefix = computeRepoBasePrefix();
      const abs = (suffix) => `${basePrefix}${suffix}`;
      templateContent = await fetchTextAny([
        './template.typ',
        '../template.typ',
        abs('/template.typ'),
        abs('/web/template.typ'),
        './web/template.typ',
      ]);

      try {
        resumeYaml = await fetchTextAny([
          './default-resume.yml',
          '../resume.yml',
          abs('/resume.yml'),
          abs('/web/default-resume.yml'),
          './web/default-resume.yml',
        ]);
      } catch (e) { }
      try {
        configYaml = await fetchTextAny([
          './default-config.yml',
          '../config.yml',
          abs('/config.yml'),
          abs('/web/default-config.yml'),
          './web/default-config.yml',
        ]);
      } catch (e) { }
      try {
        bibContent = await fetchTextAny([
          './default-publications.bib',
          '../publications.bib',
          abs('/publications.bib'),
          abs('/web/default-publications.bib'),
          './web/default-publications.bib',
        ]);
      } catch (e) { }

      return { resumeYaml, configYaml, bibContent };
    }

    async function init() {
      setStatus('Loading defaults...', '');
      let defaults = null;
      try {
        defaults = await loadDefaults();
      } catch (err) {
        overlay.querySelector('p').textContent = 'Failed: ' + err.message;
        setStatus('Init failed: ' + err.message, 'error');
        return;
      }

      cmResume.setValue(localStorage.getItem(LS_RESUME) || defaults.resumeYaml);
      cmConfig.setValue(localStorage.getItem(LS_CONFIG) || defaults.configYaml);
      cmBib.setValue(localStorage.getItem(LS_BIB) || defaults.bibContent);
      const storedPaper = localStorage.getItem(LS_PAPER);
      if (storedPaper === 'a4' || storedPaper === 'letter') {
        paperSize.value = storedPaper;
      } else {
        paperSize.value = detectPaperSize(cmConfig.getValue());
      }
      overrideVariant.value = localStorage.getItem(LS_OVERRIDE_VARIANT) || 'config';
      overrideLinks.value = localStorage.getItem(LS_OVERRIDE_LINKS) || 'config';
      overrideLinksDisabledBehavior.value = localStorage.getItem(LS_OVERRIDE_LINKS_DISABLED_BEHAVIOR) || 'config';
      overridePubnums.value = localStorage.getItem(LS_OVERRIDE_PUBNUMS) || 'config';
      overrideContact.value = localStorage.getItem(LS_OVERRIDE_CONTACT) || 'config';
      overrideFont.value = localStorage.getItem(LS_OVERRIDE_FONT) || 'config';
      overrideMonoFont.value = localStorage.getItem(LS_OVERRIDE_MONO_FONT) || 'config';

      const typstScript = document.getElementById('typst');

      function tryInit() {
        if (typeof globalThis.$typst !== 'undefined') {
          initTypst();
        } else {
          setTimeout(tryInit, 200);
        }
      }

      if (typstScript.complete || typeof globalThis.$typst !== 'undefined') {
        setTimeout(tryInit, 100);
      } else {
        typstScript.addEventListener('load', () => setTimeout(tryInit, 100));
      }
    }

    async function initTypst() {
      try {
        $typst.setCompilerInitOptions({
          getModule: () =>
            'https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-web-compiler/pkg/typst_ts_web_compiler_bg.wasm',
        });
        $typst.setRendererInitOptions({
          getModule: () =>
            'https://cdn.jsdelivr.net/npm/@myriaddreamin/typst-ts-renderer/pkg/typst_ts_renderer_bg.wasm',
        });
        ready = true;
        overlay.style.display = 'none';
        btnDownload.disabled = false;
        setStatus('Ready', 'ready');
        compile();
      } catch (err) {
        overlay.querySelector('p').textContent = 'Failed: ' + err.message;
        setStatus('Init failed: ' + err.message, 'error');
      }
    }

    init();

  </script>
</body>

</html>
