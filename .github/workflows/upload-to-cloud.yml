name: Upload Resume to Cloud Storage

# This workflow demonstrates uploading to various cloud providers.
# Uncomment and configure the provider block you need.

on:
  push:
    branches:
      - main
      - master
    paths:
      - "**.yml"
      - "**.yaml"
      - "**.typ"
      - "**.bib"
      - ".github/workflows/upload-to-cloud.yml"
  workflow_dispatch:

jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute stable last-updated date
        id: resume_meta
        shell: bash
        run: |
          LAST_UPDATED="$(git log -1 --date=format:'%B %-d, %Y' --format=%ad -- resume.yml || true)"
          if [ -z "$LAST_UPDATED" ]; then
            LAST_UPDATED="$(date '+%B %-d, %Y')"
          fi
          echo "last_updated=$LAST_UPDATED" >> "$GITHUB_OUTPUT"

      - name: Install Typst
        uses: typst-community/setup-typst@v3

      - name: Build resume PDFs
        run: |
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume.typ resume-long.pdf
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume-short.typ resume-short.pdf

      # ============================================================================
      # OPTION 1: Upload to AWS S3
      # ============================================================================
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: us-east-1
      #
      # - name: Upload to S3
      #   run: |
      #     aws s3 cp resume-long.pdf s3://your-bucket-name/resume-long.pdf --acl public-read
      #     aws s3 cp resume-short.pdf s3://your-bucket-name/resume-short.pdf --acl public-read

      # ============================================================================
      # OPTION 2: Upload to Cloudflare R2
      # ============================================================================
      # - name: Upload to Cloudflare R2
      #   uses: cloudflare/wrangler-action@v3
      #   with:
      #     apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      #     command: r2 object put your-bucket/resume-long.pdf --file=resume-long.pdf

      # ============================================================================
      # OPTION 3: Upload to GitHub Pages
      # ============================================================================
      # - name: Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v4
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: .
      #     publish_branch: gh-pages
      #     keep_files: false
      #     include: '*.pdf'

      # ============================================================================
      # OPTION 4: Upload to Google Drive
      # ============================================================================
      # - name: Upload to Google Drive
      #   run: |
      #     curl https://rclone.org/install.sh | sudo bash
      #     mkdir -p ~/.config/rclone
      #     echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf
      #     rclone copy resume-long.pdf remote:your-folder/
      #     rclone copy resume-short.pdf remote:your-folder/

      # ============================================================================
      # Default enabled output: upload as GitHub artifact
      # ============================================================================
      - name: Upload as GitHub artifact
        uses: actions/upload-artifact@v4
        with:
          name: resume-pdfs-${{ github.sha }}
          path: |
            resume-long.pdf
            resume-short.pdf
          retention-days: 90
