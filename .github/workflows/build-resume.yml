name: Build Resume PDFs

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"
    paths:
      - "resume.yml"
      - "resume-bibtex.yml"
      - "config.yml"
      - "config-short.yml"
      - "publications.bib"
      - "template.typ"
      - "*.typ"
      - ".github/workflows/build-resume.yml"
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute stable last-updated date
        id: resume_meta
        shell: bash
        run: |
          LAST_UPDATED="$(git log -1 --date=format:'%B %-d, %Y' --format=%ad -- resume.yml || true)"
          if [ -z "$LAST_UPDATED" ]; then
            LAST_UPDATED="$(date '+%B %-d, %Y')"
          fi
          echo "last_updated=$LAST_UPDATED" >> "$GITHUB_OUTPUT"

      - name: Install Typst
        uses: typst-community/setup-typst@v3
        with:
          typst-version: latest

      - name: Build long resume
        run: typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume.typ resume-long.pdf

      - name: Build short resume
        run: typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume-short.typ resume-short.pdf

      - name: Build config-driven resume
        run: typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume-with-config.typ resume-config.pdf

      - name: Build BibTeX resume
        run: typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume-with-bibtex.typ resume-bibtex.pdf

      - name: Upload resume PDFs (PR preview)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: resume-pdfs
          path: |
            resume-long.pdf
            resume-short.pdf
            resume-config.pdf
            resume-bibtex.pdf

      - name: Update latest release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Resume PDFs
          make_latest: true
          files: |
            resume-long.pdf
            resume-short.pdf
            resume-config.pdf
            resume-bibtex.pdf
          body: |
            Auto-updated resume PDFs from `${{ github.sha }}`

            - **resume-long.pdf** — Full resume
            - **resume-short.pdf** — Short resume
            - **resume-config.pdf** — Config-driven resume
            - **resume-bibtex.pdf** — BibTeX resume
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && github.ref != 'refs/tags/latest'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute stable last-updated date
        id: resume_meta
        shell: bash
        run: |
          LAST_UPDATED="$(git log -1 --date=format:'%B %-d, %Y' --format=%ad -- resume.yml || true)"
          if [ -z "$LAST_UPDATED" ]; then
            LAST_UPDATED="$(date '+%B %-d, %Y')"
          fi
          echo "last_updated=$LAST_UPDATED" >> "$GITHUB_OUTPUT"

      - name: Install Typst
        uses: typst-community/setup-typst@v3

      - name: Build resume PDFs
        run: |
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume.typ resume-long.pdf
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume-short.typ resume-short.pdf
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume-with-config.typ resume-config.pdf
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" resume-with-bibtex.typ resume-bibtex.pdf

      - name: Create versioned release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            resume-long.pdf
            resume-short.pdf
            resume-config.pdf
            resume-bibtex.pdf
          body: |
            ## Resume PDFs
            Generated resume PDFs for ${{ github.ref_name }}
            - `resume-long.pdf` — Full resume
            - `resume-short.pdf` — Short resume
            - `resume-config.pdf` — Config-driven resume
            - `resume-bibtex.pdf` — BibTeX resume
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
