name: Build Resume PDFs

on:
  push:
    branches: [main, master]
    paths:
      - "resume.yml"
      - "resume-bibtex.yml"
      - "config.yml"
      - "config-short.yml"
      - "publications.bib"
      - "template.typ"
      - "*.typ"
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Typst
        uses: typst-community/setup-typst@v3
        with:
          typst-version: latest

      - name: Build long resume
        run: typst compile resume.typ resume-long.pdf

      - name: Build short resume
        run: typst compile resume-short.typ resume-short.pdf

      - name: Upload resume PDFs (PR preview)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: resume-pdfs
          path: |
            resume-long.pdf
            resume-short.pdf

      - name: Update latest release
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Resume PDFs
          make_latest: true
          files: |
            resume-long.pdf
            resume-short.pdf
          body: |
            Auto-updated resume PDFs from `${{ github.sha }}` on ${{ github.event.head_commit.timestamp }}

            - **resume-long.pdf** — Full resume
            - **resume-short.pdf** — Short resume
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && github.ref != 'refs/tags/latest'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Typst
        uses: typst-community/setup-typst@v3

      - name: Build resume PDFs
        run: |
          typst compile resume.typ resume-long.pdf
          typst compile resume-short.typ resume-short.pdf

      - name: Create versioned release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            resume-long.pdf
            resume-short.pdf
          body: |
            ## Resume PDFs
            Generated resume PDFs for ${{ github.ref_name }}
            - `resume-long.pdf` — Full resume
            - `resume-short.pdf` — Short resume
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
