name: Build Resume PDFs

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*"
    paths:
      - "resume.yml"
      - "resume-bibtex.yml"
      - "config.yml"
      - "config-short.yml"
      - "publications.bib"
      - "template.typ"
      - "*.typ"
      - ".github/workflows/build-resume.yml"
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute stable last-updated date
        id: resume_meta
        shell: bash
        run: |
          LAST_UPDATED="$(git log -1 --date=format:'%B %-d, %Y' --format=%ad -- resume.yml || true)"
          if [ -z "$LAST_UPDATED" ]; then
            LAST_UPDATED="$(date '+%B %-d, %Y')"
          fi
          RAW_NAME="$(sed -nE 's/^  name:[[:space:]]*"?([^"]+)"?/\1/p' resume.yml | head -n1)"
          if [ -n "$RAW_NAME" ]; then
            FIRST_NAME="$(echo "$RAW_NAME" | awk '{print $1}')"
            LAST_NAME="$(echo "$RAW_NAME" | awk '{print $NF}')"
            if [ "$FIRST_NAME" = "$LAST_NAME" ]; then
              NAME_STEM="$FIRST_NAME"
            else
              NAME_STEM="${FIRST_NAME}${LAST_NAME}"
            fi
            NAME_STEM="$(echo "$NAME_STEM" | tr -cd '[:alnum:]')"
          fi
          if [ -z "${NAME_STEM:-}" ]; then
            NAME_STEM="Resume"
          fi
          RESUME_FILENAME_MAIN="${NAME_STEM}_Resume.pdf"
          RESUME_FILENAME_S="${NAME_STEM}_Resume_S.pdf"
          RESUME_FILENAME_B="${NAME_STEM}_Resume_B.pdf"
          RESUME_FILENAME_N="${NAME_STEM}_Resume_N.pdf"
          RESUME_PATH_MAIN="artifacts/${RESUME_FILENAME_MAIN}"
          RESUME_PATH_S="artifacts/${RESUME_FILENAME_S}"
          RESUME_PATH_B="artifacts/${RESUME_FILENAME_B}"
          RESUME_PATH_N="artifacts/${RESUME_FILENAME_N}"
          echo "last_updated=$LAST_UPDATED" >> "$GITHUB_OUTPUT"
          echo "name_stem=$NAME_STEM" >> "$GITHUB_OUTPUT"
          echo "resume_filename_main=$RESUME_FILENAME_MAIN" >> "$GITHUB_OUTPUT"
          echo "resume_filename_s=$RESUME_FILENAME_S" >> "$GITHUB_OUTPUT"
          echo "resume_filename_b=$RESUME_FILENAME_B" >> "$GITHUB_OUTPUT"
          echo "resume_filename_n=$RESUME_FILENAME_N" >> "$GITHUB_OUTPUT"
          echo "resume_path_main=$RESUME_PATH_MAIN" >> "$GITHUB_OUTPUT"
          echo "resume_path_s=$RESUME_PATH_S" >> "$GITHUB_OUTPUT"
          echo "resume_path_b=$RESUME_PATH_B" >> "$GITHUB_OUTPUT"
          echo "resume_path_n=$RESUME_PATH_N" >> "$GITHUB_OUTPUT"

      - name: Install Typst
        uses: typst-community/setup-typst@v3
        with:
          typst-version: latest

      - name: Build default resume (config long)
        run: |
          mkdir -p artifacts
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" --input "mode=default" resume.typ "${{ steps.resume_meta.outputs.resume_path_main }}"

      - name: Build short resume
        run: typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" --input "mode=short" resume.typ "${{ steps.resume_meta.outputs.resume_path_s }}"

      - name: Build BibTeX resume
        run: typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" --input "mode=bibtex" resume.typ "${{ steps.resume_meta.outputs.resume_path_b }}"

      - name: Build no-JS resume
        run: typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" --input "mode=no-js" resume.typ "${{ steps.resume_meta.outputs.resume_path_n }}"

      - name: Upload resume PDFs (PR preview)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.resume_meta.outputs.name_stem }}-resume-pdfs
          path: |
            ${{ steps.resume_meta.outputs.resume_path_main }}
            ${{ steps.resume_meta.outputs.resume_path_s }}
            ${{ steps.resume_meta.outputs.resume_path_b }}
            ${{ steps.resume_meta.outputs.resume_path_n }}

      - name: Update latest release
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Resume PDFs
          make_latest: true
          files: |
            ${{ steps.resume_meta.outputs.resume_path_main }}
            ${{ steps.resume_meta.outputs.resume_path_s }}
            ${{ steps.resume_meta.outputs.resume_path_b }}
            ${{ steps.resume_meta.outputs.resume_path_n }}
          body: |
            Auto-updated resume PDFs from `${{ github.sha }}`

            - **${{ steps.resume_meta.outputs.resume_filename_main }}** — Default resume (config long)
            - **${{ steps.resume_meta.outputs.resume_filename_s }}** — Short resume
            - **${{ steps.resume_meta.outputs.resume_filename_b }}** — BibTeX resume
            - **${{ steps.resume_meta.outputs.resume_filename_n }}** — Plain-text links disabled
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') && github.ref != 'refs/tags/latest'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute stable last-updated date
        id: resume_meta
        shell: bash
        run: |
          LAST_UPDATED="$(git log -1 --date=format:'%B %-d, %Y' --format=%ad -- resume.yml || true)"
          if [ -z "$LAST_UPDATED" ]; then
            LAST_UPDATED="$(date '+%B %-d, %Y')"
          fi
          RAW_NAME="$(sed -nE 's/^  name:[[:space:]]*"?([^"]+)"?/\1/p' resume.yml | head -n1)"
          if [ -n "$RAW_NAME" ]; then
            FIRST_NAME="$(echo "$RAW_NAME" | awk '{print $1}')"
            LAST_NAME="$(echo "$RAW_NAME" | awk '{print $NF}')"
            if [ "$FIRST_NAME" = "$LAST_NAME" ]; then
              NAME_STEM="$FIRST_NAME"
            else
              NAME_STEM="${FIRST_NAME}${LAST_NAME}"
            fi
            NAME_STEM="$(echo "$NAME_STEM" | tr -cd '[:alnum:]')"
          fi
          if [ -z "${NAME_STEM:-}" ]; then
            NAME_STEM="Resume"
          fi
          RESUME_FILENAME_MAIN="${NAME_STEM}_Resume.pdf"
          RESUME_FILENAME_S="${NAME_STEM}_Resume_S.pdf"
          RESUME_FILENAME_B="${NAME_STEM}_Resume_B.pdf"
          RESUME_FILENAME_N="${NAME_STEM}_Resume_N.pdf"
          RESUME_PATH_MAIN="artifacts/${RESUME_FILENAME_MAIN}"
          RESUME_PATH_S="artifacts/${RESUME_FILENAME_S}"
          RESUME_PATH_B="artifacts/${RESUME_FILENAME_B}"
          RESUME_PATH_N="artifacts/${RESUME_FILENAME_N}"
          echo "last_updated=$LAST_UPDATED" >> "$GITHUB_OUTPUT"
          echo "name_stem=$NAME_STEM" >> "$GITHUB_OUTPUT"
          echo "resume_filename_main=$RESUME_FILENAME_MAIN" >> "$GITHUB_OUTPUT"
          echo "resume_filename_s=$RESUME_FILENAME_S" >> "$GITHUB_OUTPUT"
          echo "resume_filename_b=$RESUME_FILENAME_B" >> "$GITHUB_OUTPUT"
          echo "resume_filename_n=$RESUME_FILENAME_N" >> "$GITHUB_OUTPUT"
          echo "resume_path_main=$RESUME_PATH_MAIN" >> "$GITHUB_OUTPUT"
          echo "resume_path_s=$RESUME_PATH_S" >> "$GITHUB_OUTPUT"
          echo "resume_path_b=$RESUME_PATH_B" >> "$GITHUB_OUTPUT"
          echo "resume_path_n=$RESUME_PATH_N" >> "$GITHUB_OUTPUT"

      - name: Install Typst
        uses: typst-community/setup-typst@v3

      - name: Build resume PDFs
        run: |
          mkdir -p artifacts
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" --input "mode=default" resume.typ "${{ steps.resume_meta.outputs.resume_path_main }}"
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" --input "mode=short" resume.typ "${{ steps.resume_meta.outputs.resume_path_s }}"
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" --input "mode=bibtex" resume.typ "${{ steps.resume_meta.outputs.resume_path_b }}"
          typst compile --input "last_updated=${{ steps.resume_meta.outputs.last_updated }}" --input "mode=no-js" resume.typ "${{ steps.resume_meta.outputs.resume_path_n }}"

      - name: Create versioned release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.resume_meta.outputs.resume_path_main }}
            ${{ steps.resume_meta.outputs.resume_path_s }}
            ${{ steps.resume_meta.outputs.resume_path_b }}
            ${{ steps.resume_meta.outputs.resume_path_n }}
          body: |
            ## Resume PDFs
            Generated resume PDFs for ${{ github.ref_name }}
            - `${{ steps.resume_meta.outputs.resume_filename_main }}` — Default resume (config long)
            - `${{ steps.resume_meta.outputs.resume_filename_s }}` — Short resume
            - `${{ steps.resume_meta.outputs.resume_filename_b }}` — BibTeX resume
            - `${{ steps.resume_meta.outputs.resume_filename_n }}` — Plain-text links disabled
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
